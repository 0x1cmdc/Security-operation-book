# T1583-002-获取基础设施-DNS服务

## 来自ATT&CK的描述

在入侵受害者之前，攻击者可以设置他们自己的域名系统（DNS）服务器，以在目标定位过程中使用。在后渗透期间，攻击者可能会将DNS流量用于各种任务，包括命令和控制（例如：应用程序层协议）。攻击者可以选择配置并运行自己的域名服务器来支持攻击活动，而不是劫持现有的域名服务器。

通过运行自己的域名服务器，攻击者可以更好地控制服务器端DNS C2流量。拥有控制的域名服务器，攻击者可以配置DNS应用程序以提供对恶意软件的条件响应，并且通常来说，这会使攻击者在基于DNS的C2通道的结构中拥有更大的灵活性。

## 测试案例

### DNS Tunneling

DNS Tunneling是隐蔽通道的一种，通过将其他协议封装在DNS协议中传输。因为在互联网中DNS是一个必不可少的服务，所以大部分防火墙和入侵检测设备很少会对DNS流量进行过滤，由此DNS作为隐蔽信道有天生优势。

#### 原理

DNS Tunneling可以分为直连和中继两种。

直连：client直接和指定的目标DNS Server(Authoritative NS Server)连接，通过将数据编码封装在DNS协议中进行通信。这种方式速度快，但是隐蔽性较弱，容易被探测到，且存在的限制比较多，很多场景不允许自己指定DNS Server。

中继：通过迭代DNS查询可以实现中继通道，更为隐蔽，但同时因为数据包到达目标DNS Server前需要经过多个节点，所以速度上较慢，但是可以突破防火墙等的限制。

### DNS隧道工具

使用DNS over HTTPS（DoH）构建弹性C2基础架构：<https://xz.aliyun.com/t/3068>

## 检测日志

无法有效监测

## 测试复现

无

## 测试留痕

无

## 检测规则/思路

无

## 建议

### 缓解措施

这种技术不容易用预防控制来缓解，因为它是基于企业防御和控制范围之外的行为。

### 检测

这种活动大多发生在防御团队（组织）的能见度之外，使得对这种行为的检测变得困难。检测工作可能集中在攻击生命周期的相关阶段，如在指挥和控制期间。

## 参考推荐

MITRE-ATT&CK-T1583-002

<https://attack.mitre.org/techniques/T1583/002/>

使用DNS over HTTPS（DoH）构建弹性C2基础架构

<https://xz.aliyun.com/t/3068>
